---
output: html_document
bibliography: references.bib
thanks: "Code and data are available at: [https://github.com/Kluckyyou/STA313A2](https://github.com/Kluckyyou/STA313A2)."
---

<style>
/* CSS FOR INTRO SECTION */
.intro {
  height: 100vh;
  width: 100%;
}

.intro-headers {
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  text-align: center;
  color: lightskyblue;
  font-style: normal;
  width: 60%;
}

.title {
  font-size: 70px;                   /* Larger font size for the main title */
  font-weight: bold;                 /* Bold font weight for emphasis */
  color: lightskyblue;                    /* Yellow color similar to the example */
  font-family: Georgia, serif;       /* Use Georgia or a similar serif font */
  margin: 0;
  line-height: 1.1;                  /* Tighter line height */
  padding: 10px;                     /* Add padding around text */
  display: inline-block;             /* Keeps the border tight around text */
  text-shadow: 3px 3px 8px rgba(0, 0, 0, 0.7); /* Text shadow for emphasis */
  text-align: center;
}

.subtitle {
  font-size: 40px;            /* Slightly larger font size for the subtitle */
  font-weight: normal;        /* Normal font weight */
  color: lightskyblue;               /* White color for the subtitle */
  font-family: 'Times New Roman', Times, serif; /* A serif font for contrast */
  margin-top: 10px;
  line-height: 1.2;           /* Adjust line height for spacing */
  text-shadow: 3px 3px 8px rgba(0, 0, 0, 0.7); /* Text shadow for emphasis */
  text-align: center;
}

.author-date {
  font-size: 30px;
  font-weight: normal;
  color: white;
  text-align: left;
  margin-top: 30px;
  font-style: italic;
  text-shadow: 3px 3px 8px rgba(0, 0, 0, 0.7); /* Text shadow for emphasis */
  text-align: center;
}

.intro-vid {
  height: 100vh;
  width: 100%;
  object-fit: cover;
}

.arrow {
  position: absolute;
  bottom: 2em;
  left: 50%;
  transform: translateX(-50%);
  z-index: 3;
  width: 60px;
  height: 40px;
  padding-top: 1em;
}

.arrow path {
  stroke: white;
  stroke-width: 2px;
  fill: none;
}

.introduction {
    font-size: 18px;
    width: 90%;
    max-width: 800px;
    margin: 0 auto;
    margin-bottom: 2em;
}
.theft-overview {
    font-size: 18px;
    width: 90%;
    max-width: 800px;
    margin: 0 auto;
    margin-bottom: 2em;
}
.their-targets {
    font-size: 18px;
    width: 90%;
    max-width: 800px;
    margin: 0 auto;
    margin-bottom: 2em;
}
.prevention {
    font-size: 18px;
    width: 90%;
    max-width: 800px;
    margin: 0 auto;
    margin-bottom: 2em;
}
.conclusion {
    font-size: 18px;
    width: 90%;
    max-width: 800px;
    margin: 0 auto;
    margin-bottom: 2em;
}
</style>

<div class="intro">
  <div class="intro-headers">
  <div class="title">Bikes are in danger</div>
  <div class="subtitle">Analyze theft patterns and protect bicycles</div>
  
  <div class="author-date">Visualization made by Kevin You and Yuewen Zhang<br>November 12, 2024</div>
  </div>
  <svg class = "arrow">
    <path d = "M0 0 L20 20 L40 0" opacity = "0">
        <animate
        attributeName = "d"
        begin = "1s"
        values = "M0 0 L20 20 L40 0; M0 20 L20 40 L40 20"
        dur = "1.5s"
        repeatCount = "indefinite" />
        <animate
        attributeName = "opacity"
        begin = "1s"
        values = "0; 1; 0"
        dur = "1.5s"
        repeatCount = "indefinite" />
    </path>
  </svg>
  <video class="intro-vid" src="cover-vid.mp4" muted autoplay loop></video>
</div>


<h2>Introduction</h2>
<div class="introduction">
  <p>Bicycle theft is a common problem in many cities, especially in places where bicycles are the most important and convenient means of transportation. Toronto is a good example. In Toronto, bicycle theft cases are endless. The case display chart on the website shows that thefts often occur in every community. This problem causes economic losses to the owners and affects social security. Through this collation and analysis of the theft data and in-depth research, we hope to understand the targets and methods of theft and find ways to reduce the occurrence of cases.</p>
</div>
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo=FALSE, include=TRUE, eval=TRUE)
required_packages <- c(
  "lubridate", "sf", "tidyverse", "ggplot2", "ggiraph", "gganimate", "ggmap", "osmdata", "here"
  # include any packages to be installed here
) 
for (p in required_packages) { # install if missing
  if (!require(p, character.only = TRUE)) {
    install.packages(p, character.only = TRUE)
  }
}
library(lubridate)
library(tidyverse)
library(sf)
library(ggiraph)
library(ggmap)
library(osmdata)
library(here)
# you are welcome to use either the CSV file or the GeoJSON file
# GeoJSON format maybe useful if you would like to combine
# an external geospatial dataset
bike_thefts_csv <- read_csv(here("data/Bicycle_Thefts_Open_Data.csv"))
bike_thefts_sf <- read_sf(here("data/Bicycle_Thefts_Open_Data.geojson")) |>
  mutate(
    occurence_date = as_date(
      OCC_DATE, format = "%a, %d %b %Y %H:%M:%S GMT"
    ),
    report_date = as_date(
      REPORT_DATE, format = "%a, %d %b %Y %H:%M:%S GMT"
    )
  )
```

```{r include=FALSE}
# Check the first few values of OCC_DATE and REPORT_DATE
head(bike_thefts_csv$OCC_DATE, 10)
head(bike_thefts_csv$REPORT_DATE, 10)
head(bike_thefts_csv$occurence_date, 10)
head(bike_thefts_csv$report_date, 10)
```

```{r include=FALSE}

# Checking for NAs again after transformation
summary_bike_thefts_fixed <- bike_thefts_csv %>%
  summarise(across(everything(), ~ sum(is.na(.)))) %>%
  pivot_longer(cols = everything(), names_to = "variable", values_to = "na_count")

summary_bike_thefts_fixed
```

<h2>Bicycle Theft Overview</h2>
<div class="theft-overview">
  <p>Looking at bikes lost by year, we can see that the number of bicycle thefts occurring each year is large. Even though there has been a downward trend in recent years, nearly 3,000 bicycles have still been stolen. This is enough for us to pay attention. To better analyze the trend of bicycle theft, we first focus on the impact of overall time on the occurrence of theft incidents: Is there a peak period for theft?</p>
  <p>According to Bikes Lost by Months, the bar chart shows that the number of bicycle thefts has increased significantly from June to September every year, especially in July and August. This is a very interesting discovery. Why are these months the "peak period for theft"? According to the article, thieves prefer to steal bicycles when the bicycle owners are indoors and cannot see them, such as in front of cafes, gyms, and cinemas (Socalcycling. 2022, para.10). Because they need enough time to cut their locks and escape. July and August are early summer, and the weather in Toronto is warm and more suitable for outdoor activities, June to August is also a student holiday, and the increase in the number of people traveling has led to an increase in bicycles in the city. Especially in the city center of Toronto, there are many universities and high schools, and students are also the main people who use bicycles.</p>
  <p>This idea can be further verified by the bikes lost by the hour. There are three peaks at around 9:00, 12:00, and 18:00 which are all meal times. It is the best time for thieves to steal bikes when the owners are at the restaurant. Moreover, the bar chart also shows that more bikes were stolen after 18:00.</p>
  <p>It is clear that thieves have fixed preferences for the time of stealing bicycles. They know when they are most likely to succeed, such as after the sun goes down. They also know when the owner is less likely to supervise the bicycle. So do thieves have specific "preferences" for bicycle types or values?
  </p>
</div>

```{r echo=FALSE, message=FALSE, warning=FALSE}
# Grouping by OCC_MONTH and counting the number of thefts, then ranking the months in order
monthly_thefts <- bike_thefts_csv %>%
  group_by(OCC_MONTH) %>%
  summarise(theft_count = n()) %>%
  arrange(match(OCC_MONTH, month.abb))

# Creating an interactive bar chart of OCC_MONTH versus number of thefts with zoom capabilities
ggplot_interactive <- ggplot(monthly_thefts, aes(x = OCC_MONTH, y = theft_count, tooltip = paste("Theft count:", theft_count), data_id = OCC_MONTH)) +
  geom_bar_interactive(stat = "identity", fill = "steelblue", width = 0.7) +
  labs(
    title = "Bicycle Thefts by Month",
    x = "Month of Occurrence",
    y = "Number of Bicycle Thefts"
  ) +
  theme_minimal() +
  theme(
    panel.spacing = unit(1, "lines"),
    axis.text.x = element_text(angle = 45, hjust = 1)
  )

# Adding interactive zoom functionality
girafe(ggobj = ggplot_interactive)
```

```{r echo=FALSE, message=FALSE, warning=FALSE}


# Calculating the number of thefts in each hour of the day for each weekday
hourly_weekday_count <- bike_thefts_csv %>%
  group_by(OCC_DOW, OCC_HOUR) %>%
  summarise(theft_count = n(), .groups = 'drop') %>%
  ungroup()

# Creating a scatter line plot with different colors for each weekday
ggplot_hour_weekday <- ggplot(hourly_weekday_count, aes(x = OCC_HOUR, y = theft_count, color = OCC_DOW, group = OCC_DOW)) +
  geom_line(size = 1.2) +
  geom_point_interactive(aes(tooltip = paste("Hour:", OCC_HOUR, "<br> Thefts:", theft_count)), size = 2) +
  labs(
    title = "Bicycle Thefts by Hour and Weekday",
    x = "Hour of the Day",
    y = "Number of Bicycle Thefts",
    color = "Weekday"
  ) +
  theme_minimal() +
  theme(
    panel.spacing = unit(1, "lines"),
    axis.text.x = element_text(angle = 45, hjust = 1),
    plot.margin = margin(1, 2, 1, 2, "cm")  # Adding space to horizontally stretch the chart
  ) +
  coord_cartesian(expand = TRUE) +  # Expanding the horizontal space
  transition_reveal(OCC_HOUR)

# Adding animation for the scatter line plot
# Ensure required packages for rendering animation are installed
if (!requireNamespace("gifski", quietly = TRUE)) install.packages("gifski")
if (!requireNamespace("av", quietly = TRUE)) install.packages("av")
if (!requireNamespace("magick", quietly = TRUE)) install.packages("magick")

animate(ggplot_hour_weekday, nframes = 100, fps = 10)
```

```{r echo=FALSE, message=FALSE, warning=FALSE}
# Top 10 neighborhoods by bike theft incidents
top_neighbourhoods <- bike_thefts_csv %>%
  count(NEIGHBOURHOOD_140) %>%
  arrange(desc(n)) %>%
  head(10)

# Bar plot of top neighborhoods
ggplot(top_neighbourhoods, aes(x = reorder(NEIGHBOURHOOD_140, n), y = n)) +
  geom_bar(stat = "identity") +
  coord_flip() +
  labs(title = "Top 10 Neighborhoods by Bike Theft Incidents", x = "Neighborhood", y = "Number of Thefts")

```

```{r echo=FALSE, message=FALSE, warning=FALSE}

# Get bounding box for Toronto (approximate limits for Toronto)
toronto_bbox <- c(-79.6303856025883, 43.5822069220627, -79.1180336515019, 43.8554571861712)

# Fetch map data from OpenStreetMap (OSM)
toronto_map <- opq(bbox = toronto_bbox) %>%
  add_osm_feature(key = "highway", value = "primary") %>%
  add_osm_feature(key = 'highway', value = 'secondary') %>%
  add_osm_feature(key = 'highway', value = 'tertiary') %>%
  add_osm_feature(key = 'highway', value = 'residential') %>%
  osmdata_sf()

# Aggregate neighborhoods by division
divisions <- st_read(here("data/TPS_POLICE_DIVISIONS_1455152879175798879.gpkg"), quiet = TRUE)
neighborhoods_per_division <- bike_thefts_csv %>%
  group_by(DIVISION) %>%
  summarise(theft_count = n(),
            neighborhoods = paste(unique(NEIGHBOURHOOD_158), collapse = ", "))

# Merge the aggregated data with division boundaries
divisions <- divisions %>% 
  left_join(neighborhoods_per_division, by = c("DIV" = "DIVISION")) %>%
  mutate(tooltip = paste("Division:", DIV, "<br>",
                         "Theft Count:", theft_count, "<br>",
                         "Neighborhoods:", neighborhoods))


# Plot using ggplot2 with OSM background
p <- ggplot() +
  geom_sf(data = toronto_map$osm_lines, color = "grey80", size = 0.2) +  # OSM streets as background
  geom_sf_interactive(data = divisions, aes(fill = theft_count, tooltip = tooltip, data_id = DIV), 
                      color = "black", inherit.aes = FALSE, alpha = 0.6) +
  scale_fill_gradient(low = "lightblue", high = "darkblue") +
  labs(title = "Toronto Police Divisions by Bicycle Theft Count", fill = "Theft Count") +
  theme_minimal()

# Render the interactive plot
girafe(ggobj = p)
```

```{r include=FALSE}
# Count the total number of unique premises types
premises_type_count <- bike_thefts_csv %>%
  group_by(PREMISES_TYPE) %>%
  summarise(count = n()) %>%
  arrange(desc(count))

# Display the result
premises_type_count

# Count the number of unique values for all variables in the dataset
unique_values_count <- bike_thefts_csv %>%
  summarise(across(everything(), ~ n_distinct(.))) %>%
  pivot_longer(cols = everything(), names_to = "variable", values_to = "unique_count")

# Display the result
unique_values_count
```

```{r echo=FALSE, message=FALSE, warning=FALSE}
# Plotting the number of crimes by premises type
ggplot(bike_thefts_csv, aes(x = PREMISES_TYPE)) +
  geom_bar(fill = "lightblue", color = "black") +
  labs(
    title = "Number of Bike Thefts by Premises Type",
    x = "Premises Type",
    y = "Number of Crimes"
  ) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```

<h2>What are their targets?</h2>
<div class="their-targets">
  <p>In terms of divisions, Division 52 reported the highest number of bicycle thefts, with 6,325 incidents, followed closely by Division 14 with 6,095 cases, and Division 51 with 5,885 cases. These divisions primarily cover downtown Toronto and adjacent neighborhoods, which are densely populated and heavily trafficked by cyclists, increasing both the concentration of bicycles and opportunities for theft.</p>
  <p>Looking at location types, the highest number of thefts occurred around apartments, condos, and rooming houses, accounting for 8,851 cases. This is likely due to the increased bicycle usage by urban residents who may lack private or secure storage spaces. Streets, roads, highways, and bicycle paths also saw high numbers, with 6,803 incidents, suggesting that public, open spaces with limited surveillance create favorable conditions for theft. Single-family homes and houses ranked third, with 5,335 cases, indicating that even residential neighborhoods with private storage options are not immune.</p>
  <p>Regarding premises type, outside areas ranked highest, with 10,835 cases, suggesting that bicycles parked in unsupervised or easily accessible outdoor spaces are most vulnerable to theft. Apartments again were a significant location, likely due to high urban density and limited secure storage, accounting for 8,851 cases. Houses saw 5,335 incidents, further showing that private property does not guarantee bicycle security.</p>
</div>

```{r echo=FALSE, message=FALSE, warning=FALSE}
# Creating a pie chart of theft cases by STATUS
status_count <- bike_thefts_csv %>%
  group_by(STATUS) %>%
  summarise(count = n(), .groups = "drop") %>%
  mutate(percentage = count / sum(count) * 100)

# Interactive Pie chart of theft status
library(ggiraph)
ggplot_status_interactive <- ggplot(status_count, aes(x = "", y = count, fill = STATUS, tooltip = paste(STATUS, "- Count:", count, " (", round(percentage, 2), "%)"))) +
  geom_bar_interactive(stat = "identity", width = 1) +
  coord_polar("y", start = 0) +
  labs(
    title = "Bicycle Theft Cases by Status",
    fill = "Status"
  ) +
  theme_void() +
  theme(
    plot.title = element_text(hjust = 0.5),
    legend.title = element_text(face = "bold")
  )

girafe(ggobj = ggplot_status_interactive)
```

```{r echo=FALSE, message=FALSE, warning=FALSE}


# Convert date columns from string format to POSIXct date-time format
bike_thefts_csv <- bike_thefts_csv %>%
  mutate(
    occurence_date = mdy_hms(OCC_DATE),
    report_date = mdy_hms(REPORT_DATE)
  )

# Calculating time difference and categorizing the report time differences
bike_thefts_csv <- bike_thefts_csv %>%
  mutate(
    time_diff = as.numeric(difftime(report_date, occurence_date, units = "hours")),
    time_category = case_when(
      time_diff <= 24 ~ "Within 24 hours",
      time_diff > 24 & time_diff <= 48 ~ "1 to 2 days",
      time_diff > 48 & time_diff <= 168 ~ "2 to 7 days",
      time_diff > 168 ~ "Over 7 days"
    )
  )

# Counting the number of thefts in each time category
time_category_count <- bike_thefts_csv %>%
  group_by(time_category) %>%
  summarise(count = n(), .groups = "drop") %>%
  mutate(percentage = count / sum(count) * 100)

# Interactive Pie chart of report time differences
ggplot_time_category_interactive <- ggplot(time_category_count, aes(x = "", y = count, fill = time_category, tooltip = paste(time_category, "- Count:", count, " (", round(percentage, 2), "%)"))) +
  geom_bar_interactive(stat = "identity", width = 1) +
  coord_polar("y", start = 0) +
  scale_fill_brewer(palette = "Set3") + # Adding color palette to ensure enough colors for all categories
  labs(
    title = "Bicycle Theft Cases by Report Time Difference",
    fill = "Report Time Difference"
  ) +
  theme_void() +
  theme(
    plot.title = element_text(hjust = 0.5),
    legend.title = element_text(face = "bold")
  )

# Render the interactive pie chart
girafe(ggobj = ggplot_time_category_interactive)
```
<h2>How can we prevent bike theft?</h2>
<div class="prevention">
  <p>At present, we have analyzed the high-incidence period, high-incidence area, and the main targets of thieves for bicycle thefts, so how should we apply these analyses to better prevent bicycle thefts? </p>
  <p>First, patrols should be increased at night and during the high-incidence period. We can see that most bicycle thefts occur at night because it is dark and there are few people at night, making it more difficult to discover. Therefore, the security measures in the community should be strengthened. </p>
  <p>Secondly, according to the analysis, outside thefts are more often, so we need to pay more attention to these areas. During the high-incidence period, bicycle centralized parking areas should be set up in commercial areas (such as Eaton Center) or parks and other places with high traffic volume for easy supervision. These areas need to be monitored or guarded to reduce the risk of theft.</p>
  <p>Finally, bicycle owners should strengthen their awareness of anti-theft, especially those who are "favored" by thieves. Buying higher-quality anti-theft locks, parking in places with monitoring, and installing GPS locators on bicycles are all good ways.</p>
</div>
```{r echo=FALSE, message=FALSE, warning=FALSE}
# Creating a pie chart of theft cases by BIKE_TYPE
bike_type_count <- bike_thefts_csv %>%
  group_by(BIKE_TYPE) %>%
  summarise(count = n(), .groups = "drop") %>%
  mutate(percentage = count / sum(count) * 100)

# Interactive Pie chart of theft cases by BIKE_TYPE
ggplot_bike_type_interactive <- ggplot(bike_type_count, aes(x = "", y = count, fill = BIKE_TYPE, tooltip = paste(BIKE_TYPE, "- Count:", count, " (", round(percentage, 2), "%)"))) +
  geom_bar_interactive(stat = "identity", width = 1) +
  coord_polar("y", start = 0) +
  scale_fill_brewer(palette = "Set3") + # Adding color palette to ensure enough colors for all categories
  labs(
    title = "Bicycle Theft Cases by Bike Type",
    fill = "Bike Type"
  ) +
  theme_void() +
  theme(
    plot.title = element_text(hjust = 0.5),
    legend.title = element_text(face = "bold")
  )

girafe(ggobj = ggplot_bike_type_interactive)
```

```{r echo=FALSE, message=FALSE, warning=FALSE}
# Creating 7 levels for BIKE_COST
bike_thefts_csv <- bike_thefts_csv %>%
  mutate(
    bike_cost_level = case_when(
      BIKE_COST <= 100 ~ "< $100",
      BIKE_COST > 100 & BIKE_COST <= 300 ~ "$100 - $300",
      BIKE_COST > 300 & BIKE_COST <= 500 ~ "$300 - $500",
      BIKE_COST > 500 & BIKE_COST <= 1000 ~ "$500 - $1000",
      BIKE_COST > 1000 & BIKE_COST <= 2000 ~ "$1000 - $2000",
      BIKE_COST > 2000 & BIKE_COST <= 5000 ~ "$2000 - $5000",
      BIKE_COST > 5000 ~ "> $5000"
    )
  )

# Counting the number of thefts in each bike cost level
bike_cost_count <- bike_thefts_csv %>%
  group_by(bike_cost_level) %>%
  summarise(count = n(), .groups = "drop") %>%
  mutate(percentage = count / sum(count) * 100)

# Interactive Pie chart of theft cases by BIKE_COST level
ggplot_bike_cost_interactive <- ggplot(bike_cost_count, aes(x = "", y = count, fill = bike_cost_level, tooltip = paste(bike_cost_level, "- Count:", count, " (", round(percentage, 2), "%)"))) +
  geom_bar_interactive(stat = "identity", width = 1) +
  coord_polar("y", start = 0) +
  scale_fill_brewer(palette = "Set3") + # Adding color palette to ensure enough colors for all categories
  labs(
    title = "Bicycle Theft Cases by Bike Cost Level",
    fill = "Bike Cost Level"
  ) +
  theme_void() +
  theme(
    plot.title = element_text(hjust = 0.5),
    legend.title = element_text(face = "bold")
  )

girafe(ggobj = ggplot_bike_cost_interactive)
```
<h2>Conclusion</h2>
<div class="conclusion">
  <p>In conclusion, we conducted an in-depth analysis of bicycle theft data in Toronto and learned about the thieves' preferences for time and location. By analyzing the time variable, we learned that bicycles are more likely to be stolen when the owner stays indoors for a long time; by analyzing the location variable, we found that bicycles outdoors and in apartments are more likely to be stolen. In response to such findings, we proposed feasible countermeasures: strengthen security in apartments, set up centralized bicycle management areas in commercial areas with high traffic, and install GPS positioning on bicycles. We hope that these analyses can make Toronto citizens more vigilant about bicycle thefts and take effective measures to prevent bicycle thefts.</p>
</div>